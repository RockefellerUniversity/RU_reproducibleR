---
title: "Conda and Herper<html><div style='float:left'></div><hr color='#EB811B' size=1px width=796px></html>"
author: "Rockefeller University, Bioinformatics Resource Centre"
date: "https://rockefelleruniversity.github.io/RU_reproducibleR/"
output: 
  xaringan::moon_reader:
    css: ["default", "metropolisCustom.css", "metropolis-fontsCustom.css"]
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
  html_document:
    toc: true # table of content true
    toc_float: yes
    depth: 3  # upto three depths of headings (specified by #, ## and ###)
    number_sections: false  ## if you want number sections at each table header
    theme: united  # many options for theme, this one is my favorite.
    highlight: tango  # specifies the syntax highlighting style
params:
  isSlides: "no"
---
```{r setup, include=FALSE}
suppressPackageStartupMessages(require(knitr))
knitr::opts_chunk$set(echo = TRUE, tidy = T, eval=F)
```

```{r, results='asis',include=TRUE,echo=FALSE}
if(params$isSlides != "yes"){
  cat("# Conda

---
"    
  )
  
}

```


## What is Conda?

(Conda)[https://conda.org/] is an open-source and cross-platform package and environment management system. 

It was originally developed to help manage packages for Python, but that has expanded beyond python and is very popular with R users as well. 

---
## Why Conda?

* Simplify Package Management
* Cross-Platform Compatibility
* Extensive Package Ecosystem
* Environment Management

---
## Conda vs miniconda vs ...

There are many different repository tools in the conda ecosystem. They all have key differences. 

Conda -
Miniconda -
Anaconda -
Mamba -
Minimamba -

---
## Conda best practices (maybe not necessary()

How does it work?


---
```{r, results='asis',include=TRUE,echo=FALSE}
if(params$isSlides == "yes"){
  cat("class: inverse, center, middle

# Herper

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=720px></html> 

---
"    
  )
}else{
  cat("# Herper

---
"    
  )
  
}

```

## What is Herper

Herper is an R package that provides a simple toolset to install and manage Conda packages and environments from within the R console.

---
## Installing Tools

The **install_CondaTools()** function allows the user to specify required Conda software and the desired environment to install into.

Miniconda is installed as part of the process (by default into the r-reticulate's default Conda location - `r reticulate::miniconda_path()`) and the user's requested conda environment built within the same directory (by default `r file.path(reticulate::miniconda_path(),"envs","USERS_ENVIRONMENT_HERE")`). 

If you already have Miniconda installed or you would like to install to a custom location, you can specify the path with the *pathToMiniConda* parameter. In this example we are installing in a temporary directory, but most likely you will want to install/use a stable version of Miniconda. 

```{r}
library(Herper)
install_CondaTools(tools = "star", env = "rnaseq")

```

---
## Installing Tools with speicifc conda

We can specify where we want to install miniconda (or which conda to use if you already jhave it installed). 

```{r}
my_miniconda <- "~/Desktop/My_Conda"

install_CondaTools(tools = "star", env = "rnaseq", pathToMiniConda = my_miniconda)

```

---
## Adding more tools

```{r}
conda_paths <- install_CondaTools(tools = c("salmon","kallisto"), env = "rnaseq", updateEnv = T, pathToMiniConda = my_miniconda)

conda_paths

```

<br>

## Checking for packages in an environment with **list_CondaPkgs**
The **list_CondaPkgs** function allows users to check what packages are installed in a given environment.
```{r list_CondaPkgs}
list_CondaPkgs("rnaseq", pathToMiniConda = my_miniconda)
```


---
## Finding Conda packages with **conda_search**

If the user is unsure of the exact name, or version of a tool available on conda, they can use the **conda_search** function. Searches will find close matches for incorrect queries.

```{r conda_search}
conda_search("salmo", pathToMiniConda = my_miniconda)
```

---
## Finding Conda package versions with **conda_search**

```{r conda_search2}
conda_search("salmon", pathToMiniConda = my_miniconda)
```

---
## Finding Conda package versions with **conda_search**

Specific package versions can be searched for using the conda format i.e. "salmon==1.3", "salmon>=1.3" or "salmon<=1.3".

```{r conda_search_nuance}
conda_search("salmon<=1.0", pathToMiniConda = myMiniconda)

```


---
## Installing specific versions

We can use the same nomenclature to also install these tools. 

```{r}
conda_paths <- install_CondaTools(tools = "salmon<=1.0", env = "rnaseq", updateEnv = T, pathToMiniConda = my_miniconda)

```

---
## Installing specific versions
```{r}
list_CondaPkgs("rnaseq", pathToMiniConda = my_miniconda)
```

---
## Running software

Once you have installed your tool, you will next want to run it. We can again do this with Herper. 

with and oca are the tools for this


they are differnt. 

local will update for this r session
with will just evaluat code so run it temporarilu.


---
## with

```{r}

```


## Using external software with the **with_CondaEnv** and **local_CondaEnv** functions.

Once installed within a conda environment, many external software can be executed directly from the conda environment's bin directory without having to perform any additional actions.


Some external software however require additional environmental variable to be set in order to execute correctly. An example of this would be **Cytoscape** which requires the java home directory and java library paths to be set prior to its execution.

The Herper package uses the **[withr](https://withr.r-lib.org)** family of functions (**with_CondaEnv()** and **local_CondaEnv()**) to provide methods to **temporarily** alter the system PATH and to add or update any required environmental variables. This is done without formally activating your environment or initializing your conda.

The **with_CondaEnv** allows users to run R code with the required PATH and environmental variables automatically set. The **with_CondaEnv** function simply requires the name of conda environment and the code to be executed within this environment. Additionally we can also the **pathToMiniconda** argument to specify any custom miniconda install location. 

The **with_CondaEnv** function will update the PATH we can now run the above samtools command without specifying the full directory path to samtools.

```{r with_condaenv_SalmonWithCondaEnvEval,echo=TRUE,eval=FALSE,tidy=FALSE}
res <- with_CondaEnv("herper",
                      system2(command="samtools",args = "help",stdout = TRUE),
                      pathToMiniConda=myMiniconda)
res
```

```{r with_condaenv_SalmonWithCondaEnv, echo=FALSE, eval=TRUE}
if(!identical(.Platform$OS.type, "windows")){
  res <- with_CondaEnv("herper",
                      system2(command="samtools",args = "help",stdout = TRUE),
                      pathToMiniConda=myMiniconda)
  cat(res,sep = "\n")
}
```


The **local_CondaEnv** function acts in a similar fashion to the **with_CondaEnv** function and allows the user to temporarily update the required PATH and environmental variable from within a function. The PATH and environmental variables will be modified only until the current function ends.

**local_CondaEnv** is best used within a user-created function, allowing access to the Conda environment's PATH and variables from within the the function itself but resetting all environmental variables once complete.

```{r with_condaenv_SalmonLocalCondaEnv,echo=TRUE,eval=FALSE}
samtoolsHelp <- function(){
  local_CondaEnv("herper", pathToMiniConda=myMiniconda)
  helpMessage <- system2(command="samtools",args = "help",stdout = TRUE)
  helpMessage
}
samtoolsHelp()
```

```{r with_condaenv_SalmonLocalCondaEnvEval, echo=FALSE, eval=TRUE}
if(!identical(.Platform$OS.type, "windows")){
  samtoolsHelp <- function(){
    local_CondaEnv("herper",  pathToMiniConda=myMiniconda)
    helpMessage <- system2(command="samtools",args = "help",stdout = TRUE)
    cat(helpMessage,sep = "\n")
  }
  samtoolsHelp()
}
``` 


To further demonstrate this we will use the first command from the [seqCNA](https://www.bioconductor.org/packages/release/bioc/html/seqCNA.html) vignette. This step requires samtools. If this is not installed and available there is an error. 
```{r with_condaenv_R}
library(seqCNA)
data(seqsumm_HCC1143)
try(rco <- readSeqsumm(tumour.data = seqsumm_HCC1143), silent = FALSE)
```

Samtools is listed as a System Requirement for seqCNA, so we can first use **install_CondaSysReqs()** to install samtools. In this case we are installing samtools in the environment: seqCNA_env. We can then run the seqCNA command using **with_CondaEnv** specifying that we want to use our environment containing samtools. seqCNA can then find samtools and execute successfully. 

```{r, echo=T, eval=F}
install_CondaSysReqs(pkg="seqCNA",env="seqCNA_env",pathToMiniConda=myMiniconda)
rco <- with_CondaEnv(new="seqCNA_env",readSeqsumm(tumour.data=seqsumm_HCC1143)
 ,pathToMiniConda = myMiniconda)
summary(rco)
``` 

```{r, echo=F, eval=T}
if(!identical(.Platform$OS.type, "windows")){
install_CondaSysReqs("seqCNA",env="seqCNA_env",pathToMiniConda=myMiniconda)
rco <- with_CondaEnv(new="seqCNA_env",readSeqsumm(tumour.data=seqsumm_HCC1143)
 ,pathToMiniConda = myMiniconda)
summary(rco)
}
``` 


---
## local

```{r}


```



---
## Sharing

Once you are done you have an environment that is functioing you will want to save it. One way to back it up is to export a snapshot. i.e. yml. 

These contains all ifnroamtion. anD IT CAN BE USED TO REBUILD IT. 

aDD SANPSHOT HERE OF ONE OF THESE FILES. 


---
## Export of Conda environments to YAML files using **export_CondaEnv**.

The **export_CondaEnv** function allows the user to export the environment information to a *.yml* file. These environment YAML files contain all essential information about the package, allowing for reproducibility and easy distribution of Conda system configuration for collaboration. 

```{r export}
yml_name <- paste0("herper_", format(Sys.Date(), "%Y%m%d"), ".yml")
export_CondaEnv("herper", yml_name, pathToMiniConda = myMiniconda)
```

---
## Import of Conda environments from YAML files using **import_CondaEnv**.

The **import_CondaEnv** function allows the user to create a new conda environment from a *.yml* file. These can be previously exported from **export_CondaEnv**, conda, renv or manually created. 

Users can simply provide a path to the YAML file for import. They can also specify the environment name, but by default the name will be taken from the YAML. 

```{r import, eval=F}
testYML <- system.file("extdata/test.yml",package="Herper")
import_CondaEnv(yml_import=testYML, pathToMiniConda = myMiniconda)
```

--
## Other tricks
- Mamba
- Verbosity
- list conda env

```{r}

```



---
```{r, results='asis',include=TRUE,echo=FALSE}
if(params$isSlides == "yes"){
  cat("class: inverse, center, middle

# Pip

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=720px></html> 

---
"    
  )
}else{
  cat("# Pip

---
"    
  )
  
}

```


## What about Pip?

Pip is an alternative system to install python tools. But it typically only works with python tools.

Pip doesn't handle conflicting dependencies, and will upgrade/downgrade software without checking if something else depends on it. 

Even if this doesn't break your tools, it may give different results and hinder reproducibility as unsupported versions of tools could be used.

Conda is much more considered, and checks installs to make sure that all your dependencies do not conflict. 

---
## Why use Pip?

* Not very Conda build is peffect.
* Not every tool on conda

Sometimes we are forced to use pip. But that does not mean we have to leave our environment behind. 

---
## Export env





---
## PIp install


---
## Check envs



---
```{r, results='asis',include=TRUE,echo=FALSE}
if(params$isSlides == "yes"){
  cat("class: inverse, center, middle

# Renv and Conda

<html><div style='float:left'></div><hr color='#EB811B' size=1px width=720px></html> 

---
"    
  )
}else{
  cat("# Renv and Conda

---
"    
  )
  
}

```













---
## Further Resources


 

---
## Exercises

Exercise on Reproducibility in R can be found [here](../../exercises/exercises/ReproducibleR_exercise.html)


---
## Contact

Any suggestions, comments, edits or questions (about content or the slides themselves) please reach out to our [GitHub](https://github.com/RockefellerUniversity/Reproducible_R/issues) and raise an issue.


